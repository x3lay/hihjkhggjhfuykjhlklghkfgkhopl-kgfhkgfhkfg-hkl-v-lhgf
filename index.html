<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Burini Smart ‚Äî –ò–ò‚Äë—á–∞—Ç</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <!-- Tailwind CSS (for modern, responsive utility classes) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://kit.fontawesome.com/a7d8ec7750.js" crossorigin="anonymous"></script>
    
    <style>
        /* ===== Design system: Grok 2.0 (Perfected Dark Theme) ===== */
        :root {
            --bg: #000000;
            --layer1: rgba(10, 10, 15, 0.95); /* Deep background */
            --layer2: rgba(25, 25, 30, 0.90); /* Input/Chat bubbles */
            --layer3: rgba(40, 40, 50, 0.85); /* Hover/Code background */
            --text: #ffffff;
            --muted: #a0a0b0;
            --accent: #f49c00; /* Richer, deep orange */
            --border: rgba(255, 255, 255, 0.08);
            --ok: #00d084;
            --danger: #ff4757;
            --radius: 1rem; /* 16px */
            --shadow-deep: 0 10px 30px rgba(0,0,0,0.8);
        }

        /* –ó–≤–µ–∑–¥–Ω—ã–π –§–æ–Ω (Subtle Parallax Effect) */
        #stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(2px 2px at 20px 30px, var(--text), rgba(0,0,0,0)),
                radial-gradient(2px 2px at 40px 70px, var(--muted), rgba(0,0,0,0)),
                radial-gradient(1px 1px at 50px 160px, var(--text), rgba(0,0,0,0)),
                radial-gradient(2px 2px at 90px 40px, var(--muted), rgba(0,0,0,0)),
                radial-gradient(1px 1px at 100px 100px, var(--text), rgba(0,0,0,0));
            background-repeat: repeat;
            background-size: 200px 200px;
            pointer-events: none;
            z-index: 0;
            animation: moveStars 180s linear infinite;
            opacity: 0.2;
        }

        @keyframes moveStars {
            from { background-position: 0 0; }
            to { background-position: 1000px 1000px; }
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden; 
            position: relative;
        }
        
        #app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        /* Sidebar Styling and Responsiveness */
        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateX(-100%);
            z-index: 50;
            box-shadow: var(--shadow-deep);
        }

        #sidebar.open {
            transform: translateX(0);
        }

        /* Main Content and Header */
        header {
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
            background-color: var(--layer1);
        }

        #input-panel {
            box-shadow: 0 -4px 15px rgba(0, 0, 0, 0.7);
            background: linear-gradient(to top, var(--layer1), rgba(10, 10, 15, 0.8));
        }

        /* Chat Message Styling */
        .chat-bubble {
            max-width: 85%;
            border-radius: var(--radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
        }
        .chat-bubble code {
            background-color: var(--layer3);
            color: var(--accent);
            padding: 0.1rem 0.4rem;
            border-radius: 0.4rem;
            font-size: 0.875rem;
        }

        /* Mode Buttons Styling */
        .mode-btn {
            padding: 0.5rem 1rem;
            border-radius: 1rem;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }
        .mode-btn:not(.active) {
            background-color: var(--layer2);
            color: var(--muted);
            border: 1px solid var(--border);
        }
        .mode-btn.active {
            background-color: var(--accent);
            color: var(--layer1); /* Dark text on bright accent */
            font-weight: 700;
            box-shadow: 0 0 15px rgba(244, 156, 0, 0.4);
        }

        /* Scrollbar styles (for WebKit browsers) */
        .scrollbar-thin::-webkit-scrollbar { width: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: var(--layer1); }
        .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--layer3); border-radius: 3px; }
        .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        /* Settings Panel */
        #settings-panel {
            transition: opacity 0.3s, transform 0.3s;
        }

        @media (min-width: 768px) {
            #sidebar {
                position: static;
                transform: translateX(0);
                width: 280px;
            }
            #app-container {
                flex-direction: row;
            }
            #menu-btn, #sidebar-overlay {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-black">
    <div id="stars"></div>
    <div id="app-container">
        
        <!-- –ó–∞—Ç–µ–º–Ω–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é -->
        <div id="sidebar-overlay" class="fixed top-0 left-0 w-full h-full bg-black/60 z-40 opacity-0 pointer-events-none transition-opacity duration-300" onclick="toggleSidebar(false)"></div>

        <!-- –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é —á–∞—Ç–æ–≤ (Sidebar) -->
        <aside id="sidebar" class="fixed top-0 left-0 w-4/5 max-w-xs md:static bg-[var(--layer1)] flex flex-col border-r border-[var(--border)] h-full">
            <div class="p-4 flex items-center justify-between border-b border-[var(--border)]">
                <h2 class="text-2xl font-black text-[var(--accent)] tracking-widest">BURINI</h2>
                <button id="close-sidebar-btn" class="md:hidden text-white hover:text-[var(--accent)] p-2 rounded-full transition-colors">
                    <i class="fa-solid fa-xmark text-2xl"></i>
                </button>
            </div>
            
            <div id="chat-list" class="flex-grow overflow-y-auto space-y-2 p-3 scrollbar-thin">
                <button id="new-chat-btn" class="w-full bg-[var(--layer2)] text-white border-2 border-[var(--border)] hover:bg-[var(--layer3)] transition-all p-3 rounded-xl font-medium mb-3 shadow-lg active:scale-[0.98]">
                    <i class="fa-solid fa-plus mr-2 text-[var(--accent)]"></i> –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
                </button>
                <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>

            <!-- –ë–ª–æ–∫ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –≤–Ω–∏–∑—É —Å–∞–π–¥–±–∞—Ä–∞ -->
            <div class="p-4 border-t border-[var(--border)]">
                <div class="text-[var(--muted)] text-xs mb-2 truncate">–°—Ç–∞—Ç—É—Å: <span id="display-user-id" class="font-mono text-white text-sm">–õ–æ–∫–∞–ª—å–Ω—ã–π</span></div>
                <button id="settings-btn" class="w-full text-left p-3 rounded-xl hover:bg-[var(--layer3)] transition-colors text-white flex items-center justify-between">
                    <span class="font-medium"><i class="fa-solid fa-cog mr-2 text-[var(--accent)]"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
                    <i class="fa-solid fa-chevron-right text-xs"></i>
                </button>
            </div>
        </aside>

        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç (Chat Main) -->
        <main id="chat-main" class="flex-grow flex flex-col overflow-hidden">
            <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
            <header class="p-3 flex items-center justify-between sticky top-0 z-30 border-b border-[var(--border)]">
                <div class="flex items-center space-x-3">
                    <button id="menu-btn" class="md:hidden text-white hover:text-[var(--accent)] p-2 rounded-full transition-colors">
                        <i class="fa-solid fa-bars text-xl"></i>
                    </button>
                    <h1 id="chat-title" class="text-xl font-bold truncate max-w-[180px] sm:max-w-full">Burini AI Chat</h1>
                </div>
                <span id="user-badge" class="text-xs font-mono bg-[var(--accent)] text-black px-3 py-1 rounded-full font-bold shadow-md">LOCAL MODE</span>
            </header>

            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-5 scrollbar-thin">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div id="input-panel" class="p-4 border-t border-[var(--border)]">
                <!-- –í—ã–±–æ—Ä —Ä–µ–∂–∏–º–∞/–º–æ–¥–µ–ª–∏ -->
                <div id="mode-selector" class="flex flex-wrap gap-2 mb-3 justify-center p-2 rounded-xl bg-black/50 border border-[var(--border)]">
                    <button class="mode-btn" data-mode="smart" data-model="x-ai/grok-4-fast:free">
                        <span class="mode-text">üöÄ Smart Chat</span>
                    </button>
                    <button class="mode-btn" data-mode="vision" data-model="deepseek/deepseek-chat-v3.1:free">
                        <span class="mode-text">üëÅÔ∏è Vision</span>
                    </button>
                    <button class="mode-btn" data-mode="studio" data-model="mistralai/mistral-7b-instruct-v0.2">
                        <span class="mode-text">üíª Code Studio</span>
                    </button>
                </div>

                <div class="flex items-end space-x-2">
                    <textarea id="prompt-input" class="flex-grow bg-[var(--layer2)] text-white placeholder-gray-500 rounded-xl p-3 resize-none focus:ring-2 focus:ring-[var(--accent)] focus:outline-none max-h-40 overflow-y-auto text-base border border-[var(--border)]" rows="1" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
                    <button id="send-btn" class="bg-[var(--accent)] text-black w-12 h-12 rounded-full flex items-center justify-center transition-all disabled:opacity-50 hover:bg-yellow-500 active:scale-90 shadow-xl focus:ring-2 focus:ring-[var(--accent)]">
                        <i class="fa-solid fa-paper-plane text-xl"></i>
                    </button>
                </div>
            </div>
        </main>

        <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ (Settings Panel) -->
        <div id="settings-panel" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] transform transition-opacity duration-300 opacity-0 pointer-events-none flex items-center justify-center">
            <div class="bg-[var(--layer1)] p-6 rounded-2xl shadow-2xl w-full max-w-sm m-4 transform translate-y-0 transition-transform duration-500 border border-[var(--border)]">
                <h3 class="text-2xl font-bold mb-6 text-[var(--accent)] border-b border-[var(--border)] pb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>
                
                <div class="space-y-5">
                    
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å LLM -->
                    <div>
                        <label for="model-select" class="block text-white mb-2 font-medium">–û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</label>
                        <select id="model-select" class="w-full bg-[var(--layer2)] text-white p-3 rounded-xl border border-[var(--border)] focus:ring-[var(--accent)] focus:border-[var(--accent)]">
                            <option value="x-ai/grok-4-fast:free">Grok-4 Fast (–ë—ã—Å—Ç—Ä—ã–π)</option>
                            <option value="deepseek/deepseek-chat-v3.1:free">DeepSeek (Vision/Code)</option>
                            <option value="mistralai/mistral-7b-instruct-v0.2">Mistral 7B (–≠–∫–æ–Ω–æ–º)</option>
                        </select>
                    </div>

                    <!-- –ó–≤–µ–∑–¥–Ω—ã–π –§–æ–Ω Toggle -->
                    <div class="flex justify-between items-center bg-[var(--layer2)] p-3 rounded-xl border border-[var(--border)]">
                        <label for="stars-toggle" class="text-white font-medium">–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω</label>
                        <input type="checkbox" id="stars-toggle" class="h-5 w-5 text-[var(--accent)] rounded focus:ring-[var(--accent)] bg-gray-600 border-gray-700" checked>
                    </div>

                    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
                    <div class="flex justify-between items-center bg-[var(--layer2)] p-3 rounded-xl border border-[var(--border)]">
                        <label for="notify-toggle" class="text-white font-medium">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                        <input type="checkbox" id="notify-toggle" class="h-5 w-5 text-[var(--accent)] rounded focus:ring-[var(--accent)] bg-gray-600 border-gray-700" checked>
                    </div>
                </div>

                <button id="close-settings-btn" class="mt-8 w-full bg-[var(--accent)] text-black p-3 rounded-xl font-bold hover:opacity-90 transition-opacity active:scale-[0.98] shadow-md">
                    –ó–∞–∫—Ä—ã—Ç—å –∏ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
            </div>
        </div>

        <!-- Toast Notification Container -->
        <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-[1000] w-full max-w-xs px-4">
            <!-- –¢–æ—Å—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>

    </div>

    <!-- Telegram WebApp Script -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="module">
        
        // --- –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã Local Storage ---
        const CHATS_STORAGE_KEY = 'burini_chats_v1';
        const SETTINGS_STORAGE_KEY = 'burini_settings_v1';
        const API_URL = '/api/chat'; 

        // --- DOM Elements (–°–æ–∫—Ä–∞—â–µ–Ω–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞) ---
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebar-overlay');
        const menuBtn = document.getElementById('menu-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const messagesContainer = document.getElementById('messages-container');
        const promptInput = document.getElementById('prompt-input');
        const sendBtn = document.getElementById('send-btn');
        const chatList = document.getElementById('chat-list');
        const newChatBtn = document.getElementById('new-chat-btn');
        const chatTitleEl = document.getElementById('chat-title');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const modelSelect = document.getElementById('model-select');
        const modeButtons = document.querySelectorAll('.mode-btn');
        const starsToggle = document.getElementById('stars-toggle');
        const notifyToggle = document.getElementById('notify-toggle');
        
        // --- State Management ---
        const state = {
            currentChatId: null,
            isTyping: false,
            // –ù–∞—á–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            settings: {
                starsEnabled: true,
                currentModel: 'x-ai/grok-4-fast:free',
                currentMode: 'smart',
                notifications: true,
            },
            // –•—Ä–∞–Ω–∏–ª–∏—â–µ —á–∞—Ç–æ–≤: { chatId: { title: "...", messages: [...] } }
            chats: {}, 
        };

        // --- Local Storage Functions ---

        /** * –ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ (—á–∞—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) –∏–∑ Local Storage. 
         * –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.
         */
        function loadDataFromLocalStorage() {
            try {
                const storedChats = localStorage.getItem(CHATS_STORAGE_KEY);
                if (storedChats) {
                    state.chats = JSON.parse(storedChats);
                } else {
                    state.chats = {};
                }

                const storedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
                if (storedSettings) {
                    state.settings = { ...state.settings, ...JSON.parse(storedSettings) };
                }
            } catch (e) {
                console.error("Error loading data from Local Storage:", e);
                state.chats = {}; // –°–±—Ä–æ—Å –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }

        /** –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ (—á–∞—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏) –≤ Local Storage. */
        function saveDataToLocalStorage() {
            try {
                localStorage.setItem(CHATS_STORAGE_KEY, JSON.stringify(state.chats));
                localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(state.settings));
            } catch (e) {
                console.error("Error saving data to Local Storage:", e);
            }
        }
        
        // --- Utility Functions ---

        /** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è —á–∞—Ç–∞. */
        function generateId() {
            return 'chat_' + Date.now().toString(36) + Math.random().toString(36).substring(2);
        }

        /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é (–æ—Ç–∫—Ä—ã–≤–∞–µ—Ç/–∑–∞–∫—Ä—ã–≤–∞–µ—Ç). */
        function toggleSidebar(open) {
            if (open) {
                sidebar.classList.add('open');
                sidebarOverlay.classList.add('open');
            } else {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('open');
            }
        }

        /** –ü—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ DOM. */
        function applySettings() {
            document.getElementById("stars").style.display = state.settings.starsEnabled ? "block" : "none";
            starsToggle.checked = state.settings.starsEnabled;
            notifyToggle.checked = state.settings.notifications;
            modelSelect.value = state.settings.currentModel;

            modeButtons.forEach(btn => {
                const isSelected = btn.dataset.mode === state.settings.currentMode;
                btn.classList.toggle('active', isSelected);
                if (isSelected) {
                     btn.dataset.model = state.settings.currentModel;
                }
            });
        }

        /** –û–±–Ω–æ–≤–ª—è–µ—Ç state.settings –∏–∑ UI –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ Local Storage. */
        function saveSettings() {
            state.settings.starsEnabled = starsToggle.checked;
            state.settings.currentModel = modelSelect.value;
            state.settings.notifications = notifyToggle.checked;
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º –ø–æ –∞–∫—Ç–∏–≤–Ω–æ–π –º–æ–¥–µ–ª–∏
            const activeModeBtn = Array.from(modeButtons).find(btn => btn.dataset.model === state.settings.currentModel);
            if (activeModeBtn) {
                state.settings.currentMode = activeModeBtn.dataset.mode;
            } else {
                 state.settings.currentMode = 'smart';
            }

            applySettings(); 
            saveDataToLocalStorage();
            showToast("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!");
        }

        /** –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è Toast. */
        function showToast(message, type = 'ok') {
            if (!state.settings.notifications) return;
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-3 my-2 rounded-xl text-sm font-medium shadow-2xl transition-all transform duration-300 opacity-0 translate-y-2 ${type === 'ok' ? 'bg-[var(--ok)] text-black' : 'bg-[var(--danger)] text-white'}`;
            toast.textContent = message;
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-y-2');
                toast.classList.add('opacity-100', 'translate-y-0');
            }, 10);

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-2');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3500);
        }

        /** –°–∫—Ä–æ–ª–ª–∏–Ω–≥ –∫ –ø–æ—Å–ª–µ–¥–Ω–µ–º—É —Å–æ–æ–±—â–µ–Ω–∏—é. */
        function scrollToBottom() {
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // --- Chat Functions ---

        /** –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π —á–∞—Ç. */
        function createNewChat() {
            const newChatId = generateId();
            state.chats[newChatId] = {
                id: newChatId,
                title: "–ù–æ–≤—ã–π —á–∞—Ç",
                createdAt: Date.now(),
                mode: state.settings.currentMode,
                messages: []
            };
            saveDataToLocalStorage();
            renderChatList();
            selectChat(newChatId);
        }

        /** –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —á–∞—Ç. */
        function selectChat(chatId) {
            state.currentChatId = chatId;
            renderCurrentChat();
            
            document.querySelectorAll('.chat-item').forEach(el => {
                el.classList.remove('bg-gray-700', 'font-bold');
                if (el.dataset.id === chatId) {
                    el.classList.add('bg-gray-700', 'font-bold');
                }
            });

            if (window.innerWidth < 768) {
                toggleSidebar(false);
            }
        }

        /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤. */
        function renderChatList() {
            chatList.innerHTML = '';
            chatList.appendChild(newChatBtn); 
            
            // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ —Å–æ–∑–¥–∞–Ω–∏—è
            const sortedChatIds = Object.keys(state.chats).sort((a, b) => state.chats[b].createdAt - state.chats[a].createdAt);

            let firstChatId = null;
            
            sortedChatIds.forEach((chatId) => {
                const chat = state.chats[chatId];
                if (!firstChatId) firstChatId = chatId;

                const chatItem = document.createElement('button');
                chatItem.className = 'chat-item w-full text-left p-3 rounded-xl transition-colors truncate hover:bg-[var(--layer3)] active:scale-[0.98]';
                chatItem.dataset.id = chatId;
                chatItem.onclick = () => selectChat(chatId);
                chatItem.innerHTML = `<i class="fa-solid fa-message mr-2 text-[var(--accent)]"></i> ${chat.title}`;
                chatList.appendChild(chatItem);
            });
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            if (!state.currentChatId && firstChatId) {
                selectChat(firstChatId);
            } else if (!state.currentChatId && sortedChatIds.length === 0) {
                 createNewChat(); // –ï—Å–ª–∏ —á–∞—Ç–æ–≤ –≤–æ–æ–±—â–µ –Ω–µ—Ç, —Å–æ–∑–¥–∞–µ–º
            } else if (state.currentChatId && !state.chats[state.currentChatId]) {
                 // –ï—Å–ª–∏ —Ç–µ–∫—É—â–∏–π ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±—ã–ª —É–¥–∞–ª–µ–Ω), –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π
                 selectChat(firstChatId);
            } else {
                 // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞ –¥–ª—è –∞–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–∞)
                 renderCurrentChat();
            }
        }

        /** –†–µ–Ω–¥–µ—Ä–∏—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —á–∞—Ç–∞. */
        function renderCurrentChat() {
            const chatId = state.currentChatId;
            const chat = state.chats[chatId];
            if (!chat) return;

            chatTitleEl.textContent = chat.title || "–ù–æ–≤—ã–π —á–∞—Ç";
            messagesContainer.innerHTML = '';
            
            if (chat.messages.length === 0) {
                 messagesContainer.innerHTML = `
                    <div class="text-center text-[var(--muted)] pt-8">
                        <i class="fa-solid fa-robot text-5xl text-[var(--accent)] mb-3 opacity-70"></i>
                        <p class="text-lg font-semibold">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å Burini AI.</p>
                        <p class="text-sm mt-1">–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: <strong>${state.settings.currentMode.toUpperCase()}</strong></p>
                        <p class="text-xs mt-1">–ú–æ–¥–µ–ª—å: ${state.settings.currentModel.split('/')[1] || 'Grok'}</p>
                    </div>
                 `;
            }

            chat.messages.forEach(msg => {
                messagesContainer.appendChild(createMessageElement(msg));
            });
            scrollToBottom();
        }
        
        /** –°–æ–∑–¥–∞–µ—Ç DOM-—ç–ª–µ–º–µ–Ω—Ç —Å–æ–æ–±—â–µ–Ω–∏—è. */
        function createMessageElement(msg) {
            const isUser = msg.role === 'user';
            const bubbleClasses = isUser 
                ? 'bg-[var(--accent)] text-black ml-auto font-medium' 
                : 'bg-[var(--layer2)] mr-auto text-white border border-[var(--border)]';

            const container = document.createElement('div');
            container.className = 'flex ' + (isUser ? 'justify-end' : 'justify-start');

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble p-3 shadow-md ${bubbleClasses}`;
            
            // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Markdown (–±–∞–∑–æ–≤–æ–µ)
            let htmlContent = msg.content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/`(.*?)`/g, '<code class="bg-[var(--layer3)] text-[var(--accent)] px-1 rounded text-sm">$&</code>')
                .replace(/\n/g, '<br>');
                
            bubble.innerHTML = htmlContent;

            container.appendChild(bubble);
            return container;
        }

        /** –î–æ–±–∞–≤–ª—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏. */
        function addTypingIndicator() {
            // ... (–ª–æ–≥–∏–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π) ...
            const existing = document.getElementById('typing-indicator');
            if (existing) return;

            const container = document.createElement('div');
            container.id = 'typing-indicator';
            container.className = 'flex justify-start mb-4';
            
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator bg-[var(--layer2)] p-3 rounded-xl shadow-lg flex space-x-1';
            indicator.innerHTML = `
                <span class="w-2 h-2 bg-[var(--accent)] rounded-full"></span>
                <span class="w-2 h-2 bg-[var(--accent)] rounded-full"></span>
                <span class="w-2 h-2 bg-[var(--accent)] rounded-full"></span>
            `;
            container.appendChild(indicator);
            messagesContainer.appendChild(container);
            state.isTyping = true;
            scrollToBottom();
        }

        /** –£–¥–∞–ª—è–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø–µ—á–∞—Ç–∏. */
        function removeTypingIndicator() {
            // ... (–ª–æ–≥–∏–∫–∞ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏ –æ—Å—Ç–∞–µ—Ç—Å—è –ø—Ä–µ–∂–Ω–µ–π) ...
            const indicator = document.getElementById('typing-indicator');
            if (indicator) {
                indicator.remove();
            }
            state.isTyping = false;
        }

        /** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è LLM API. */
        async function sendMessage() {
            if (state.isTyping || !state.currentChatId) return;

            const userPrompt = promptInput.value.trim();
            if (!userPrompt) return;

            const currentChat = state.chats[state.currentChatId];
            if (!currentChat) return showToast("–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π.", 'danger');

            // 1. –°–±–æ—Ä –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–±–µ–∑ –ª–∏—à–Ω–∏—Ö –ø–æ–ª–µ–π)
            const apiMessages = currentChat.messages.map(msg => ({ role: msg.role, content: msg.content }));

            // 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ UI –∏ State
            const userMessageLocal = { role: 'user', content: userPrompt };
            currentChat.messages.push(userMessageLocal); 
            renderCurrentChat();
            saveDataToLocalStorage();
            
            // –°–±—Ä–æ—Å –ø–æ–ª—è –≤–≤–æ–¥–∞
            promptInput.value = '';
            promptInput.style.height = '48px'; 

            // 3. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –ø–µ—á–∞—Ç–∏
            addTypingIndicator();
            sendBtn.disabled = true;

            // 4. API Call
            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: state.settings.currentModel,
                        messages: [...apiMessages, { role: 'user', content: userPrompt }], 
                        mode: state.settings.currentMode, 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                const aiResponseText = data.content || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò.";

                // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞ –ò–ò –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ State
                const aiMessageLocal = { role: 'assistant', content: aiResponseText };
                currentChat.messages.push(aiMessageLocal); 

                // 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —á–∞—Ç–∞
                if (apiMessages.length === 0) {
                    const newTitle = userPrompt.substring(0, 30) + (userPrompt.length > 30 ? '...' : '');
                    currentChat.title = newTitle;
                    renderChatList(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–æ–∫
                }

            } catch (error) {
                console.error("Chat API error:", error);
                const errorMessage = error.message.includes('API Error') ? error.message : "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ò–ò.";
                const errorMsgObj = { role: 'assistant', content: `[–û—à–∏–±–∫–∞]: ${errorMessage}` };
                currentChat.messages.push(errorMsgObj);
            } finally {
                // 7. –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è UI
                removeTypingIndicator();
                sendBtn.disabled = false;
                renderCurrentChat(); 
                saveDataToLocalStorage(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Ç–æ–≥–æ–≤—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Local Storage
            }
        }
        
        // --- Initialization ---

        function initializeApp() {
            // 1. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Local Storage
            loadDataFromLocalStorage();
            
            // 2. –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
            applySettings();

            // 3. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤ –∏ –≤—ã–±–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —á–∞—Ç–∞
            renderChatList();
        }

        // --- Event Listeners ---

        // –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö
        menuBtn.onclick = () => toggleSidebar(true);
        closeSidebarBtn.onclick = () => toggleSidebar(false);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        sendBtn.onclick = sendMessage;
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã textarea
        promptInput.addEventListener('input', function() {
            this.style.height = '48px'; 
            this.style.height = Math.min(this.scrollHeight, 160) + 'px'; 
        });

        // –ö–Ω–æ–ø–∫–∞ "–ù–æ–≤—ã–π —á–∞—Ç"
        newChatBtn.onclick = createNewChat;

        // –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫
        settingsBtn.onclick = () => {
            settingsPanel.classList.remove('opacity-0', 'pointer-events-none');
        };
        closeSettingsBtn.onclick = () => { 
            settingsPanel.classList.add('opacity-0', 'pointer-events-none');
            saveSettings();
        };
        settingsPanel.addEventListener('click', (e) => {
            if (e.target === settingsPanel) { 
                settingsPanel.classList.add('opacity-0', 'pointer-events-none');
                saveSettings();
            }
        });

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤ (–∫–Ω–æ–ø–æ–∫)
        modeButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                state.settings.currentMode = btn.dataset.mode;
                state.settings.currentModel = btn.dataset.model;
                
                applySettings(); 
                saveSettings(); 
                if (state.currentChatId) renderCurrentChat(); 
            });
        });

        // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤ —Å–µ–ª–µ–∫—Ç–µ –∏ —á–µ–∫–±–æ–∫—Å–∞—Ö
        [modelSelect, starsToggle, notifyToggle].forEach(el => el.addEventListener("change", saveSettings));
        
        // --- –ó–∞–ø—É—Å–∫ ---
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            window.Telegram.WebApp.setHeaderColor('#000000'); 
            window.Telegram.WebApp.setBackgroundColor('#000000');
        } else {
            console.warn("Telegram WebApp object not found. Running in standalone mode.");
        }

        initializeApp();

    </script>
</body>
</html>
