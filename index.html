<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Burini Smart ‚Äî –ò–ò‚Äë—á–∞—Ç</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#000000">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    // Tailwind perf: reduce preflight when possible
    tailwind.config = {
      corePlugins: {
        preflight: true,
      }
    }
  </script>
  <script src="https://kit.fontawesome.com/a7d8ec7750.js" crossorigin="anonymous"></script>

  <style>
    :root {
      --bg: #000000;
      --layer1: rgba(10, 10, 15, 0.95);
      --layer2: rgba(25, 25, 30, 0.90);
      --layer3: rgba(40, 40, 50, 0.85);
      --text: #ffffff;
      --muted: #a0a0b0;
      --accent: #f49c00;
      --border: rgba(255, 255, 255, 0.08);
      --ok: #00d084;
      --danger: #ff4757;
      --radius: 1rem;
      --shadow-deep: 0 10px 30px rgba(0,0,0,0.8);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
      --safe-top: env(safe-area-inset-top, 0px);
    }

    html, body {
      height: 100%;
      background: var(--bg);
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      overflow: hidden; /* –∂–µ—Å—Ç–∫–æ: —Ç.–∫. –µ—Å—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∫—Ä–æ–ª–ª –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      position: relative;
      -webkit-tap-highlight-color: transparent;
    }

    #stars {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      background:
        radial-gradient(2px 2px at 20px 30px, var(--text), rgba(0,0,0,0)),
        radial-gradient(2px 2px at 40px 70px, var(--muted), rgba(0,0,0,0)),
        radial-gradient(1px 1px at 50px 160px, var(--text), rgba(0,0,0,0)),
        radial-gradient(2px 2px at 90px 40px, var(--muted), rgba(0,0,0,0)),
        radial-gradient(1px 1px at 100px 100px, var(--text), rgba(0,0,0,0));
      background-repeat: repeat;
      background-size: 200px 200px;
      pointer-events: none;
      z-index: 0;
      animation: moveStars 180s linear infinite;
      opacity: 0.18;
      will-change: transform;
    }

    @keyframes moveStars {
      from { background-position: 0 0; }
      to { background-position: 1000px 1000px; }
    }

    #app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 10;
    }

    /* Sidebar */
    #sidebar {
      transition: transform 0.24s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateX(-100%);
      z-index: 50;
      box-shadow: var(--shadow-deep);
      will-change: transform;
      backface-visibility: hidden;
    }
    #sidebar.open {
      transform: translateX(0);
    }

    header {
      box-shadow: 0 2px 10px rgba(0,0,0,0.5);
      background-color: var(--layer1);
      padding-top: calc(0.75rem + var(--safe-top));
    }

    #messages-container {
      overscroll-behavior: contain;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    #input-panel {
      box-shadow: 0 -4px 15px rgba(0,0,0,0.7);
      background: linear-gradient(to top, var(--layer1), rgba(10,10,15,0.86));
      padding-bottom: calc(1rem + var(--safe-bottom));
    }

    /* Chat bubble */
    .chat-bubble {
      max-width: 88%;
      border-radius: var(--radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.4);
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .chat-bubble code {
      background-color: var(--layer3);
      color: var(--accent);
      padding: 0.1rem 0.4rem;
      border-radius: 0.4rem;
      font-size: 0.875rem;
    }

    .mode-btn {
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      transition: all 0.16s ease;
      font-size: 0.875rem;
    }
    .mode-btn:not(.active) {
      background-color: var(--layer2);
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .mode-btn.active {
      background-color: var(--accent);
      color: var(--layer1);
      font-weight: 700;
      box-shadow: 0 0 15px rgba(244, 156, 0, 0.4);
    }

    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: var(--layer1); }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: var(--layer3); border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: var(--accent); }

    #settings-panel {
      transition: opacity 0.2s ease, transform 0.3s;
      will-change: opacity, transform;
      backface-visibility: hidden;
    }

    @media (min-width: 768px) {
      #sidebar {
        position: static;
        transform: translateX(0);
        width: 280px;
      }
      #app-container {
        flex-direction: row;
      }
      #menu-btn, #sidebar-overlay {
        display: none !important;
      }
    }

    /* Tap-friendly buttons */
    button, select, textarea {
      touch-action: manipulation;
    }
  </style>
</head>

<body class="bg-black">
  <div id="stars"></div>

  <div id="app-container">
    <!-- –ú–æ–±–∏–ª—å–Ω–æ–µ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏–µ -->
    <div id="sidebar-overlay"
         class="fixed top-0 left-0 w-full h-full bg-black/60 z-40 opacity-0 pointer-events-none transition-opacity duration-200"
         onclick="toggleSidebar(false)"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 left-0 w-4/5 max-w-xs md:static bg-[var(--layer1)] flex flex-col border-r border-[var(--border)] h-full">
      <div class="p-4 flex items-center justify-between border-b border-[var(--border)]">
        <h2 class="text-2xl font-black text-[var(--accent)] tracking-widest">BURINI</h2>
        <button id="close-sidebar-btn" class="md:hidden text-white hover:text-[var(--accent)] p-2 rounded-full transition-colors">
          <i class="fa-solid fa-xmark text-2xl"></i>
        </button>
      </div>

      <div id="chat-list" class="flex-grow overflow-y-auto space-y-2 p-3 scrollbar-thin will-change-transform">
        <button id="new-chat-btn" class="w-full bg-[var(--layer2)] text-white border-2 border-[var(--border)] hover:bg-[var(--layer3)] transition-all p-3 rounded-xl font-medium mb-3 shadow-lg active:scale-[0.98]">
          <i class="fa-solid fa-plus mr-2 text-[var(--accent)]"></i> –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —á–∞—Ç
        </button>
        <!-- –ß–∞—Ç—ã —Ä–µ–Ω–¥–µ—Ä—è—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
      </div>

      <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
      <div class="p-4 border-t border-[var(--border)]">
        <div class="text-[var(--muted)] text-xs mb-2 truncate">
          –°—Ç–∞—Ç—É—Å:
          <span id="display-user-id" class="font-mono text-white text-sm">–õ–æ–∫–∞–ª—å–Ω—ã–π</span>
        </div>
        <button id="settings-btn" class="w-full text-left p-3 rounded-xl hover:bg-[var(--layer3)] transition-colors text-white flex items-center justify-between">
          <span class="font-medium"><i class="fa-solid fa-cog mr-2 text-[var(--accent)]"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
          <i class="fa-solid fa-chevron-right text-xs"></i>
        </button>
      </div>
    </aside>

    <!-- Main -->
    <main id="chat-main" class="flex-grow flex flex-col overflow-hidden">
      <header class="p-3 flex items-center justify-between sticky top-0 z-30 border-b border-[var(--border)]">
        <div class="flex items-center space-x-3">
          <button id="menu-btn" class="md:hidden text-white hover:text-[var(--accent)] p-2 rounded-full transition-colors">
            <i class="fa-solid fa-bars text-xl"></i>
          </button>
          <h1 id="chat-title" class="text-xl font-bold truncate max-w-[180px] sm:max-w-full">Burini AI Chat</h1>
        </div>
        <span id="user-badge" class="text-xs font-mono bg-[var(--accent)] text-black px-3 py-1 rounded-full font-bold shadow-md">LOCAL MODE</span>
      </header>

      <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
      <div id="messages-container" class="flex-grow overflow-y-auto p-4 space-y-5 scrollbar-thin">
        <!-- –†–µ–Ω–¥–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
      </div>

      <!-- –í–≤–æ–¥ -->
      <div id="input-panel" class="p-4 border-t border-[var(--border)]">
        <!-- –†–µ–∂–∏–º—ã -->
        <div id="mode-selector" class="flex flex-wrap gap-2 mb-3 justify-center p-2 rounded-xl bg-black/50 border border-[var(--border)]">
          <button class="mode-btn" data-mode="smart" data-model="x-ai/grok-4-fast:free">
            <span class="mode-text">üöÄ Smart Chat</span>
          </button>
          <button class="mode-btn" data-mode="vision" data-model="deepseek/deepseek-chat-v3.1:free">
            <span class="mode-text">üëÅÔ∏è Vision</span>
          </button>
          <button class="mode-btn" data-mode="studio" data-model="x-ai/grok-4-fast:free">
            <span class="mode-text">üíª Code Studio</span>
          </button>
        </div>

        <!-- –ü–æ–ª–µ –≤–≤–æ–¥–∞ -->
        <div class="flex items-end space-x-2">
          <textarea id="prompt-input"
                    class="flex-grow bg-[var(--layer2)] text-white placeholder-gray-500 rounded-xl p-3 resize-none focus:ring-2 focus:ring-[var(--accent)] focus:outline-none max-h-40 overflow-y-auto text-base border border-[var(--border)]"
                    rows="1"
                    maxlength="8000"
                    placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."></textarea>
          <button id="send-btn" class="bg-[var(--accent)] text-black w-12 h-12 rounded-full flex items-center justify-center transition-all disabled:opacity-50 hover:bg-yellow-500 active:scale-90 shadow-xl focus:ring-2 focus:ring-[var(--accent)]">
            <i class="fa-solid fa-paper-plane text-xl"></i>
          </button>
        </div>
      </div>
    </main>

    <!-- –ü–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settings-panel" class="fixed inset-0 bg-black/90 backdrop-blur-sm z-[100] transform transition-opacity duration-200 opacity-0 pointer-events-none flex items-center justify-center">
      <div class="bg-[var(--layer1)] p-6 rounded-2xl shadow-2xl w-full max-w-sm m-4 transform translate-y-0 transition-transform duration-300 border border-[var(--border)]">
        <h3 class="text-2xl font-bold mb-6 text-[var(--accent)] border-b border-[var(--border)] pb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h3>

        <div class="space-y-5">
          <!-- –û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å -->
          <div>
            <label for="model-select" class="block text-white mb-2 font-medium">–û—Å–Ω–æ–≤–Ω–∞—è –º–æ–¥–µ–ª—å (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</label>
            <select id="model-select" class="w-full bg-[var(--layer2)] text-white p-3 rounded-xl border border-[var(--border)] focus:ring-[var(--accent)] focus:border-[var(--accent)]">
              <option value="x-ai/grok-4-fast:free">Grok-4 Fast (–ë—ã—Å—Ç—Ä—ã–π)</option>
              <option value="deepseek/deepseek-chat-v3.1:free">DeepSeek (Vision/Code)</option>
            </select>
          </div>

          <!-- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç -->
          <div>
            <label for="user-system-prompt" class="block text-white mb-2 font-medium">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
            <textarea id="user-system-prompt"
                      class="w-full bg-[var(--layer2)] text-white p-3 rounded-xl border border-[var(--border)] focus:ring-[var(--accent)] focus:border-[var(--accent)]"
                      rows="3"
                      maxlength="4000"
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–û—Ç–≤–µ—á–∞–π –ø–æ–¥—Ä–æ–±–Ω–æ –∏ –¥–æ–±–∞–≤–ª—è–π –ø—Ä–∏–º–µ—Ä—ã. –ò—Å–ø–æ–ª—å–∑—É–π —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.'"></textarea>
            <p class="text-[var(--muted)] text-xs mt-1">–≠—Ç–æ—Ç –ø—Ä–æ–º–ø—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤—Å–ª–µ–¥ –∑–∞ –±–∞–∑–æ–≤—ã–º —Å–∏—Å—Ç–µ–º–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º.</p>
          </div>

          <!-- –ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω -->
          <div class="flex justify-between items-center bg-[var(--layer2)] p-3 rounded-xl border border-[var(--border)]">
            <label for="stars-toggle" class="text-white font-medium">–ö–æ—Å–º–∏—á–µ—Å–∫–∏–π —Ñ–æ–Ω</label>
            <input type="checkbox" id="stars-toggle" class="h-5 w-5 text-[var(--accent)] rounded focus:ring-[var(--accent)] bg-gray-600 border-gray-700" checked>
          </div>

          <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
          <div class="flex justify-between items-center bg-[var(--layer2)] p-3 rounded-xl border border-[var(--border)]">
            <label for="notify-toggle" class="text-white font-medium">–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
            <input type="checkbox" id="notify-toggle" class="h-5 w-5 text-[var(--accent)] rounded focus:ring-[var(--accent)] bg-gray-600 border-gray-700" checked>
          </div>
        </div>

        <button id="close-settings-btn" class="mt-8 w-full bg-[var(--accent)] text-black p-3 rounded-xl font-bold hover:opacity-90 transition-opacity active:scale-[0.98] shadow-md">
          –ó–∞–∫—Ä—ã—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
        </button>
      </div>
    </div>

    <!-- Toast -->
    <div id="toast-container" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-[1000] w-full max-w-xs px-4"></div>
  </div>

  <!-- Telegram WebApp Script -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <script type="module">
    // –ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã
    const CHATS_STORAGE_KEY = 'burini_chats_v2';
    const SETTINGS_STORAGE_KEY = 'burini_settings_v2';
    const API_URL = '/api/chat';

    // DOM
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const menuBtn = document.getElementById('menu-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const messagesContainer = document.getElementById('messages-container');
    const promptInput = document.getElementById('prompt-input');
    const sendBtn = document.getElementById('send-btn');
    const chatList = document.getElementById('chat-list');
    const newChatBtn = document.getElementById('new-chat-btn');
    const chatTitleEl = document.getElementById('chat-title');
    const settingsBtn = document.getElementById('settings-btn');
    const settingsPanel = document.getElementById('settings-panel');
    const closeSettingsBtn = document.getElementById('close-settings-btn');
    const modelSelect = document.getElementById('model-select');
    const modeButtons = document.querySelectorAll('.mode-btn');
    const starsToggle = document.getElementById('stars-toggle');
    const notifyToggle = document.getElementById('notify-toggle');
    const displayUserId = document.getElementById('display-user-id');
    const userSystemPromptEl = document.getElementById('user-system-prompt');

    // State
    const state = {
      currentChatId: null,
      isTyping: false,
      settings: {
        starsEnabled: true,
        currentModel: 'x-ai/grok-4-fast:free',
        currentMode: 'smart',
        notifications: true,
        userSystemPrompt: '',
        tgUserId: null
      },
      chats: {}, // {id: {title, createdAt, mode, messages:[]}}
    };

    // LocalStorage
    function loadDataFromLocalStorage() {
      try {
        const storedChats = localStorage.getItem(CHATS_STORAGE_KEY);
        if (storedChats) state.chats = JSON.parse(storedChats) || {};
        const storedSettings = localStorage.getItem(SETTINGS_STORAGE_KEY);
        if (storedSettings) {
          const parsed = JSON.parse(storedSettings) || {};
          state.settings = { ...state.settings, ...parsed };
        }
      } catch (e) {
        console.error('LocalStorage load error', e);
        state.chats = {};
      }
    }

    function saveDataToLocalStorage() {
      try {
        localStorage.setItem(CHATS_STORAGE_KEY, JSON.stringify(state.chats));
        localStorage.setItem(SETTINGS_STORAGE_KEY, JSON.stringify(state.settings));
      } catch (e) {
        console.error('LocalStorage save error', e);
      }
    }

    // Utils
    function toggleSidebar(open) {
      const overlay = sidebarOverlay;
      if (open) {
        sidebar.classList.add('open');
        overlay.style.opacity = '1';
        overlay.style.pointerEvents = 'auto';
      } else {
        sidebar.classList.remove('open');
        overlay.style.opacity = '0';
        overlay.style.pointerEvents = 'none';
      }
    }

    function generateId() {
      return 'chat_' + Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    function showToast(message, type = 'ok') {
      if (!state.settings.notifications) return;
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `p-3 my-2 rounded-xl text-sm font-medium shadow-2xl transition-all transform duration-300 opacity-0 translate-y-2 ${type === 'ok' ? 'bg-[var(--ok)] text-black' : 'bg-[var(--danger)] text-white'}`;
      toast.textContent = message;
      container.appendChild(toast);

      requestAnimationFrame(() => {
        toast.classList.remove('opacity-0', 'translate-y-2');
        toast.classList.add('opacity-100', 'translate-y-0');
      });

      setTimeout(() => {
        toast.classList.remove('opacity-100', 'translate-y-0');
        toast.classList.add('opacity-0', 'translate-y-2');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 2500);
    }

    function scrollToBottom() {
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    function applySettings() {
      document.getElementById('stars').style.display = state.settings.starsEnabled ? 'block' : 'none';
      starsToggle.checked = state.settings.starsEnabled;
      notifyToggle.checked = state.settings.notifications;
      modelSelect.value = state.settings.currentModel;
      userSystemPromptEl.value = state.settings.userSystemPrompt || '';

      modeButtons.forEach(btn => {
        const isSelected = btn.dataset.mode === state.settings.currentMode;
        btn.classList.toggle('active', isSelected);
      });
    }

    function saveSettings() {
      state.settings.starsEnabled = starsToggle.checked;
      state.settings.currentModel = modelSelect.value;
      state.settings.notifications = notifyToggle.checked;
      state.settings.userSystemPrompt = (userSystemPromptEl.value || '').trim();

      applySettings();
      saveDataToLocalStorage();
      showToast('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
    }

    // Chats
    function createNewChat() {
      const newChatId = generateId();
      state.chats[newChatId] = {
        id: newChatId,
        title: '–ù–æ–≤—ã–π —á–∞—Ç',
        createdAt: Date.now(),
        mode: state.settings.currentMode,
        messages: []
      };
      saveDataToLocalStorage();
      renderChatList();
      selectChat(newChatId);
    }

    function selectChat(chatId) {
      state.currentChatId = chatId;
      renderCurrentChat();

      document.querySelectorAll('.chat-item').forEach(el => {
        el.classList.remove('bg-gray-700', 'font-bold');
        if (el.dataset.id === chatId) el.classList.add('bg-gray-700', 'font-bold');
      });

      if (window.innerWidth < 768) toggleSidebar(false);
    }

    function renderChatList() {
      chatList.innerHTML = '';
      chatList.appendChild(newChatBtn);

      const sorted = Object.keys(state.chats).sort((a, b) => state.chats[b].createdAt - state.chats[a].createdAt);
      let firstChatId = null;

      sorted.forEach(chatId => {
        const chat = state.chats[chatId];
        if (!firstChatId) firstChatId = chatId;

        const btn = document.createElement('button');
        btn.className = 'chat-item w-full text-left p-3 rounded-xl transition-colors truncate hover:bg-[var(--layer3)] active:scale-[0.98]';
        btn.dataset.id = chatId;
        btn.onclick = () => selectChat(chatId);
        btn.innerHTML = `<i class="fa-solid fa-message mr-2 text-[var(--accent)]"></i> ${chat.title}`;
        chatList.appendChild(btn);
      });

      if (!state.currentChatId && firstChatId) selectChat(firstChatId);
      else if (!state.currentChatId && sorted.length === 0) createNewChat();
      else if (state.currentChatId && !state.chats[state.currentChatId]) selectChat(firstChatId);
      else renderCurrentChat();
    }

    function createMessageElement(msg) {
      const isUser = msg.role === 'user';
      const bubbleClasses = isUser
        ? 'bg-[var(--accent)] text-black ml-auto font-medium'
        : 'bg-[var(--layer2)] mr-auto text-white border border-[var(--border)]';

      const container = document.createElement('div');
      container.className = 'flex ' + (isUser ? 'justify-end' : 'justify-start');

      const bubble = document.createElement('div');
      bubble.className = `chat-bubble p-3 shadow-md ${bubbleClasses}`;

      let htmlContent = (msg.content || '')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');

      bubble.innerHTML = htmlContent;
      container.appendChild(bubble);
      return container;
    }

    function renderCurrentChat() {
      const chatId = state.currentChatId;
      const chat = state.chats[chatId];
      if (!chat) return;

      chatTitleEl.textContent = chat.title || '–ù–æ–≤—ã–π —á–∞—Ç';
      messagesContainer.innerHTML = '';

      if (chat.messages.length === 0) {
        messagesContainer.innerHTML = `
          <div class="text-center text-[var(--muted)] pt-8">
            <i class="fa-solid fa-robot text-5xl text-[var(--accent)] mb-3 opacity-70"></i>
            <p class="text-lg font-semibold">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥ —Å Burini AI.</p>
            <p class="text-sm mt-1">–¢–µ–∫—É—â–∏–π —Ä–µ–∂–∏–º: <strong>${state.settings.currentMode.toUpperCase()}</strong></p>
            <p class="text-xs mt-1">–ú–æ–¥–µ–ª—å: ${state.settings.currentModel.split('/')[1] || 'Grok'}</p>
          </div>
        `;
      }

      // –ë–∞—Ç—á —Ä–µ–Ω–¥–µ—Ä–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      const frag = document.createDocumentFragment();
      chat.messages.forEach(msg => {
        frag.appendChild(createMessageElement(msg));
      });
      messagesContainer.appendChild(frag);
      scrollToBottom();
    }

    function addTypingIndicator() {
      if (document.getElementById('typing-indicator')) return;
      const container = document.createElement('div');
      container.id = 'typing-indicator';
      container.className = 'flex justify-start mb-4';

      const indicator = document.createElement('div');
      indicator.className = 'typing-indicator bg-[var(--layer2)] p-3 rounded-xl shadow-lg flex space-x-1';
      indicator.innerHTML = `
        <span class="w-2 h-2 bg-[var(--accent)] rounded-full animate-bounce" style="animation-delay:0ms"></span>
        <span class="w-2 h-2 bg-[var(--accent)] rounded-full animate-bounce" style="animation-delay:100ms"></span>
        <span class="w-2 h-2 bg-[var(--accent)] rounded-full animate-bounce" style="animation-delay:200ms"></span>
      `;
      container.appendChild(indicator);
      messagesContainer.appendChild(container);
      state.isTyping = true;
      scrollToBottom();
    }

    function removeTypingIndicator() {
      const indicator = document.getElementById('typing-indicator');
      if (indicator) indicator.remove();
      state.isTyping = false;
    }

    async function sendMessage() {
      if (state.isTyping || !state.currentChatId) return;
      const userPrompt = promptInput.value.trim();
      if (!userPrompt) return;

      const currentChat = state.chats[state.currentChatId];
      if (!currentChat) return showToast('–ß–∞—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π.', 'danger');

      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      if (currentChat.messages.length > 500) {
        currentChat.messages = currentChat.messages.slice(-500);
      }

      const apiMessages = currentChat.messages.map(m => ({ role: m.role, content: m.content }));
      const userMessageLocal = { role: 'user', content: userPrompt };
      currentChat.messages.push(userMessageLocal);
      renderCurrentChat();
      saveDataToLocalStorage();

      promptInput.value = '';
      promptInput.style.height = '48px';
      addTypingIndicator();
      sendBtn.disabled = true;

      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: state.settings.currentModel,
            mode: state.settings.currentMode,
            messages: [...apiMessages, { role: 'user', content: userPrompt }],
            userSystemPrompt: state.settings.userSystemPrompt,
            title: 'Burini Smart',
            referer: location.origin
          })
        });

        if (!response.ok) {
          let errorText = `API Error: ${response.status}`;
          try { errorText = (await response.json()).error?.message || errorText; } catch {}
          throw new Error(errorText);
        }

        const data = await response.json();
        const aiResponseText = data.content || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –ò–ò.';
        const aiMessageLocal = { role: 'assistant', content: aiResponseText };
        currentChat.messages.push(aiMessageLocal);

        if (apiMessages.length === 0) {
          const newTitle = userPrompt.substring(0, 30) + (userPrompt.length > 30 ? '...' : '');
          currentChat.title = newTitle;
          renderChatList();
        }
      } catch (error) {
        console.error('Chat API error:', error);
        const errorMsgObj = { role: 'assistant', content: `[–û—à–∏–±–∫–∞]: ${error.message || '–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'}` };
        currentChat.messages.push(errorMsgObj);
      } finally {
        removeTypingIndicator();
        sendBtn.disabled = false;
        renderCurrentChat();
        saveDataToLocalStorage();
      }
    }

    // Telegram WebApp init
    function initTelegram() {
      if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand();
        tg.setHeaderColor('#000000');
        tg.setBackgroundColor('#000000');

        const unsafe = tg.initDataUnsafe || {};
        const user = unsafe.user;
        if (user && user.id) {
          state.settings.tgUserId = user.id;
          displayUserId.textContent = `TG:${user.id}`;
        } else {
          displayUserId.textContent = '–õ–æ–∫–∞–ª—å–Ω—ã–π';
        }
        saveDataToLocalStorage();
      } else {
        console.warn('Telegram WebApp object not found. Standalone mode.');
        displayUserId.textContent = '–õ–æ–∫–∞–ª—å–Ω—ã–π';
      }
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    function initializeApp() {
      loadDataFromLocalStorage();
      applySettings();
      initTelegram();
      renderChatList();
    }

    // Events
    menuBtn.onclick = () => toggleSidebar(true);
    closeSidebarBtn.onclick = () => toggleSidebar(false);
    newChatBtn.onclick = createNewChat;

    sendBtn.onclick = sendMessage;
    promptInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    promptInput.addEventListener('input', function() {
      this.style.height = '48px';
      this.style.height = Math.min(this.scrollHeight, 160) + 'px';
    });

    settingsBtn.onclick = () => {
      settingsPanel.classList.remove('opacity-0', 'pointer-events-none');
    };
    closeSettingsBtn.onclick = () => {
      settingsPanel.classList.add('opacity-0', 'pointer-events-none');
      saveSettings();
    };
    settingsPanel.addEventListener('click', (e) => {
      if (e.target === settingsPanel) {
        settingsPanel.classList.add('opacity-0', 'pointer-events-none');
        saveSettings();
      }
    });

    modeButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        state.settings.currentMode = btn.dataset.mode;
        state.settings.currentModel = btn.dataset.model;
        applySettings();
        saveSettings();
        if (state.currentChatId) renderCurrentChat();
      });
    });

    [modelSelect, starsToggle, notifyToggle, userSystemPromptEl].forEach(el => el.addEventListener('change', saveSettings));

    initializeApp();
  </script>
</body>
</html>
